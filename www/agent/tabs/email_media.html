<div id="emailView">
	<table>
		<tr>
			<th class="translatecol">TO</th>
			<td id="emailToSpan"></td>
		</tr>
		<tr>
			<th class="translatecol">FROM</th>
			<td id="emailFromSpan"></td>
		</tr>
		<tr>
			<th class="translatecol">SUBJECT</th>
			<td id="emailSubjectSpan"></td>
		</tr>
		<tr>
			<th class="translatecol">DATE</th>
			<td id="emailDateSpan"></td>
		</tr>
		<tr>
			<th class="translate">SHOW_HEADERS</th>
			<td>
			<button label='&rarr;' dojoType='dijit.form.Button' style="float:left">
				<script type="dojo/connect" event="onClick">
					var target = dojo.byId('emailRawHeadersSpan')
					if(target.style.display == 'none'){
						target.style.display = 'inline-block';
						this.attr('label', '&darr;');
					}
					else{
						target.style.display = 'none';
						this.attr('label', '&rarr;');
					}
				</script>
			</button>
			<span id='emailRawHeadersSpan' style='display:none'></span>
			</td>
		</tr>
		<tr>
			<th>&nbsp;</th>
			<td>
			<button label="REPLY" id="emailReply" dojoType="dijit.form.Button">
				<script type="dojo/connect" event="onClick">
					dojo.byId('emailView').style.display = 'none';
					//dojo.byId('emailReplyDiv').style.visibility = 'visible';
					dojo.byId('emailReplyDiv').style.display = 'block';
					var replyBase = dojo.doc.createElement('div');
					replyBase.id = 'emailReplyEditor';
					replyBase.style.height = '300px';
					dojo.byId('emailDisp').appendChild(replyBase);
					var widget = new dijit.Editor({height:'300px'}, replyBase);
					widget.setValue(dojo.byId('emailViewDiv').innerHTML);
				</script>
			</button>
			</td>
		</tr>
	</table>

	<div id="emailViewDiv" style="border: grey solid 1px"></div>
	
</div>

<div id="emailReplyDiv">

	<form dojoType="dijit.form.Form" action="javascript:void(0)" id="emailReplyForm">
		<div style="width:30%; float:left; padding: 2%">
			<p>
				<label class="translatecol">TO</label>
				<input dojoType="dijit.form.TextBox" id="emailTo" />
			</p>

			<p>
				<label class="translatecol">FROM</label>
				<input dojoType="dijit.form.TextBox" id="emailFrom" />
			</p>

			<p>
				<label class="translatecol">SUBJECT</label>
				<input dojoType="dijit.form.TextBox" id="emailSubject" />
			</p>

			<p>
				<label class="translatecol">ATTACHMENTS</label>
				<button dojoType="dojox.form.FileUploader" uploadUrl="/media" class="btnNormal" hoverClass="btnHover" activeClass="btnActive" disabledClass="btnDisabled", force="html", htmlFieldName="attachFiles", selectMultipleFiles="false" id='fileUploader' selectedList="attachmentList" showProgress="true">Select Files
					<script type="dojo/connect" event="onComplete">
						dojo.publish("emailPane/attachment/add", arguments[0]);
					</script>
					<script type="dojo/connect" event="onChange" args="datalist">
						var data = datalist[0];
						dojo.byId('attachmentList').innerHTML = data.name + ' ' + Math.ceil(data.size * .001) + 'kb';
					</script>
				</button>
				<span id="attachmentList"></span>
				<button label="UPLOAD" dojoType="dijit.form.Button">
					<script type="dojo/connect" event="onClick">
						var uploader = dijit.byId('fileUploader');
						uploader.upload({
							'command':'attach',
							'mode':'call',
							'filename':'fileUpload',
							'htmlFieldName':'attachFiles'
						});
					</script>
				</button>
			</p>
			
			<p id="attachmentListP">
				<label>&nbsp;</label>
				<ul style="list-style-type:none; display:inline-block" id="attachedList"></ul>
			</p>
			
			<p>
				<label>&nbsp;</label>
				<button label="SUBMIT" dojoType="dijit.form.Button" id="emailSubmit">
					<script type="dojo/connect" event="onClick">
						var coveredNode = dijit.byId('emailPanel').domNode;
						var standby = new dojox.widget.Standby({
							target: coveredNode,
							zIndex:1000
						});
						dojo.doc.body.appendChild(standby.domNode);
						standby.startup();
						standby.show();
						var sub = dojo.subscribe("agent/mediaevent/email", function(data){
							if(data.event == 'send_complete'){
								standby.hide();
								if(! data.success){
									errMessage('send mail failed' + data.message);
								} else {
									dijit.byId('emailReplyEditor').destroy();
									dojo.byId('emailView').style.display = 'block';
									dojo.byId('emailReplyDiv').style.display = 'none';
								}
								dojo.unsubscribe(sub);
							}
						});
						dojo.xhrPost({
							url:'/media',
							content:{
								'command':'send',
								'arguments':dojo.toJson({
									'to':dijit.byId('emailTo').attr('value'),
									'from':dijit.byId('emailFrom').attr('value'),
									'subject':dijit.byId('emailSubject').attr('value'),
									'body': dijit.byId('emailReplyEditor').attr('value')
								}),
								'mode':'cast'
							},
							load: function(res){
								return true;
							},
							error: function(res){
								errMessage(['mail errored', res]);
							}
						});
					</script>
				</button>
				
				<button label="CANCEL" dojoType="dijit.form.Button" id="emailCancel">
					<script type="dojo/connect" event="onClick">
						dijit.byId('emailReplyEditor').destroy();
						//var node = dojo.byId('emailReplyEditor');
						//node.parentNode.removeChild(node);
						dojo.byId('emailView').style.display = 'block';
						//dojo.byId('emailReplyDiv').style.visibility = 'hidden';
						dojo.byId('emailReplyDiv').style.display = 'none';
					</script>
				</button>
			</p>

		</div>

		<div id="emailDisp" style="width:60%; float:right; padding:2%" />

	</form>

<script type="text/javascript" src="/html-sanitizer-minified.js"></script>
<script type="text/javascript" src="tabs/email_media.js"></script>
