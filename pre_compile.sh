#! /bin/sh

if [ ! -d ebin ]; then
	mkdir ebin
fi

for file in proto_src/*.proto
do
	nameBase=`echo "$file" | sed -e "s/^proto_src\///"`
	nameBase="src/${nameBase}"
	if [ ! -e $nameBase -o $file -nt $nameBase ]
	then
		cp $file src/
	fi
done

# hack for reltool
#if [ ! -d ../deps/OpenACD ]; then
#	mkdir deps/OpenACD
#	ln -sf ../ebin deps/OpenACD/ebin
#	ln -sf ../src deps/OpenACD/src
#	ln -sf ../include deps/OpenACD/include
#	ln -sf ../priv deps/OpenACD/priv
#	ln -sf ../deps ../deps/OpenACD/deps
#fi

# record what commit/version openacd is at
OPENACD_COMMIT=""
if [ -d ".git" ]
then
	OPENACD_COMMIT=`git log -1 --pretty=format:%H`
fi
if [ -e "include/commit_ver.hrl" ] && [ ! $OPENACD_COMMIT ]
then
 exit 0
else
	if [ ! $OPENACD_COMMIT ]
	then
		OPENACD_COMMIT="undefined"
	else
		OPENACD_COMMIT="\"$OPENACD_COMMIT\""
	fi
fi
echo "%% automatically generated by OpenACD precompile script.  Editing means
%% it will just get overwritten again.

-define(OPENACD_COMMIT, $OPENACD_COMMIT)." > include/commit_ver.hrl
