<style type="text/css">
  @import "/dojo/dojox/grid/resources/Grid.css";
  @import "/dojo/dojox/grid/resources/nihiloGrid.css";

  .dojoxGrid table {
    margin: 0;
  }
</style>

<script type="text/javascript">
    dojo.require("dojox.grid.DataGrid");
	
	var spit = function(){
		console.log("spit");
		console.log(arguments)
	};
	
	mailMappings = new dojo.data.ItemFileWriteStore({
		url:"/medias/anynode/email_media_manager/getMappings"
	});
	mailMappings._saveCustom = function(savecomplete){
		var changeset = mailMappings._pending;
		var updates = [];
		for(var i in changeset._modifiedItems){
			var item = null;
			if(mailMappings._itemsByIdentity){
				item = mailMappings._itemsByIdentity[i];
			}
			else{
				item = mailMappings._arrayOfAllItems[i];
			}
			updates.push(item);
		}
		console.log(updates);
		savecomplete();
	}
</script>

<div>

<form dojoType="dijit.form.Form" action="javascript:void(0)" id="mediaForm">
<p>
	<label for="mediaEnabled">&nbsp;</label>
	<input dojoType="dijit.form.CheckBox" value="freeswitchEnabled" id="mediaEnabled" name="enabled" />
	<span id="emailEnabled">EMAILENABLED</span>
</p>

<p>
	<label for="port" id="lport">PORT:</label>
	<input dojoType="dijit.form.ValidationTextBox" name="port" regExp="[\d]+" />
</p>

<p>
	<label for="host" id="lhost">HOST:</label>
	<input dojoType="dijit.form.TextBox" name="host" id="host" />
</p>

<p>
	<label for="bindip" id="lbindip">BINDIP</label>
	<input dojoType="dijit.form.ValidationTextBox" name="bindip" regExp="(\d{1,3}\.){3}\d{1,3}" />
</p>

<p>
	<label for="relays" id="lrelays">RELAYS:</label><div style="font-size:smaller">Comma separated list</div>
	<textarea dojoType="dijit.form.Textarea" name="relays" style="width:50em"></textarea>
</p>

<p>
	<label for="mediaSubmit">&nbsp;</label>
	<button dojoType="dijit.form.Button" label="SUBMIT" id="mediaSubmit">
		<script type="dojo/method" event="postCreate">
			dojo.byId("emailEnabled").innerHTML = dojo.i18n.getLocalization("admin", "email_media_manager").EMAILENABLED + ":";
			dojo.byId("lport").innerHTML = dojo.i18n.getLocalization("admin", "email_media_manager").PORT + ":";
			dojo.byId("lrelays").innerHTML = dojo.i18n.getLocalization("admin", "email_media_manager").RELAYS + ":";
			dojo.byId("lhost").innerHTML = dojo.i18n.getLocalization("admin", "email_media_manager").HOST + ":";
			dojo.byId("lbindip").innerHTML = dojo.i18n.getLocalization("admin", "email_media_manager").BINDIP + ":";
			this.setLabel(dojo.i18n.getLocalization("admin", "labels").SUBMIT);
		</script>
	</button>
</form>
</div>

<div id="mappingsDiv" style="height:250px">
</div>

<div>
<button dojoType="dijit.form.Button" label="Add Mapping" id="mailMapAdd">
	<script type="dojo/connect" event="onClick">
		var count = 1;
		var foundIt = function(item, request){
			if(item.length > 0){
				count++;
				mailMappings.fetch({
					query:{"address":"support" + count + "@example.com"},
					onComplete:foundIt
				});
			}
			else{
				var updateLocal = function(){
					mailMappings.newItem({
						"address":"support" + count + "@example.com",
						"client":"undefined",
						"queue":"default_queue",
						"skills":""
					});
					mailMappings.save();
				};
				dojo.xhrPost({
					url:"/medias/node/email_media_manager/new",
					content:{
						"address":"support" + count + "@example.com",
						"client":"undefined",
						"queue":"default_queue",
						"skills":""
					},
					load:updateLocal
				});
			}
		}
		foundIt(["goober"]);
	</script>
</button>
<button dojoType="dijit.form.Button" label="Drop Mapping" id="mailMapDrop">
	<script type="dojo/connect" event="onClick">
		var item = mapGrid.selection.getSelected();
		if(item.length < 1){
			//nothing
		}
		else{
			item = item[0];
			if(item !== null){
				dojo.xhrPost({
					url:"/medias/node/email_media_manager/destroyMapping",
					content:{
						"address":mailMappings.getValue(item, "address")
					},
					handleAs:"json",
					load:function(res, ioargs){
						mailMappings.deleteItem(item);
						mailMappings.save();
					}
				});
			}
		}
	</script>
</button>
</div>

<script type="text/javascript">

var queueOpt = [];
var clientOpt = ["undefined"];

var mapGrid = new dojox.grid.DataGrid({
	store: mailMappings,
	jsId: "mapGrid",
	query: {address: "*"},
	selectionMode:"single",
	structure: [{
		cells: [[
			{field: "address", name: "Address", width:"200px", editable: "true"},
			{field: "queue", name: "Queue", width:"150px", editable: true, type:dojox.grid.cells.Select, options: queueOpt},
			{field: "client", name: "Client", width:"159px", editable: true, type:dojox.grid.cells.Select, options: clientOpt},
			{field: "skills", name: "Skills", width:"300px", editable:true}
		]]
	}]
}, dojo.byId("mappingsDiv"));

dojo.connect(mapGrid, "onRowClick", function(e){
	mapGrid.cachedAddress = mailMappings.getValue(mapGrid.getItem(e.rowIndex), "address");
});

dojo.connect(mapGrid, "onApplyEdit", function(row){
	var ajax = function(oldaddy, newitem){
		dojo.xhrPost({
			url:"/medias/anynode/email_media_manager/setMapping",
			content:{
				"oldaddress":oldaddy,
				"address":mailMappings.getValue(newitem, "address"),
				"queue":mailMappings.getValue(newitem, "queue"),
				"client":mailMappings.getValue(newitem, "client"),
				"skills":mailMappings.getValue(newitem, "skills")
			},
			handleAs:"json",
			load:function(resp, ioargs){
				if(resp.success){
					mailMappings.save();
				}
				else{
					console.log(resp.message);
				}
			}
		});
	}
	
	ajax(mapGrid.cachedAddress, mapGrid.getItem(row));
});

var onQueue = function(item, request){
	queueOpt.push(queues.store.getValue(item, "name"));
}

queues.store.fetch({
	query: {type:"queue"},
	queryOptions:{deep:true},
	onItem:onQueue
});

</script>
